<!-- training.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Фитнес-тренировка</title>
  <link href="https://cdn.tailwindcss.com" rel="stylesheet"/>
  <style>
    body{margin:0;font-family:Inter,sans-serif;
         background:url('/images/fitness-bg.jpg') center/cover no-repeat fixed;
         color:#f9fafb}
    .overlay{background:rgba(17,17,17,.8);min-height:100vh;padding:2rem;
             backdrop-filter:blur(10px);display:flex;flex-direction:column;
             align-items:center}
    .card{background:rgba(255,255,255,.05);border-radius:1rem;padding:1.5rem;
          max-width:800px;width:100%;margin-bottom:2rem;
          box-shadow:0 10px 30px rgba(0,0,0,.3);text-align:center;display:none}
    .card.active{display:block}
    .video-wrapper{position:relative;width:640px;height:360px;margin:0 auto;
                   border-radius:12px;overflow:hidden}
    #video,#canvas{position:absolute;top:0;left:0;width:640px;height:360px;
                   object-fit:cover}
    #instr-video{width:640px;height:360px;border-radius:12px;object-fit:cover;
                 margin:0 auto}
    #ref-img{width:320px;height:180px;margin:1rem auto 0;object-fit:contain;
             background:#000;border-radius:8px}
    .btn{padding:.75rem 1.25rem;border:none;border-radius:999px;
         font-weight:600;cursor:pointer;transition:background-color .2s}
    .btn-start{background:#22c55e;color:#000}.btn-start:hover{background:#16a34a}
    .btn-skip{background:#fbbf24;color:#000}.btn-skip:hover{background:#f59e0b}
    #timer,#score{font-size:1.25rem;margin-top:1rem}
  </style>
</head>
<body data-page="training">
<div class="overlay">
  <!-- 1) Старт -->
  <div id="controls" class="card active">
    <button id="start-btn" class="btn btn-start">Начать тренировку</button>
  </div>

  <!-- 2) Инструктаж -->
  <div id="instr-container" class="card">
    <h2 id="pose-label">Инструктаж</h2>
    <video id="instr-video" controls></video>
    <button id="skip-instr-btn" class="btn btn-skip">Пропустить</button>
  </div>

  <!-- 3) Позирование -->
  <div id="camera-container" class="card">
    <h2 id="pose-label-2">Позирование</h2>
    <div class="video-wrapper">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="canvas"></canvas>
    </div>
    <img id="ref-img" alt="Эталонная поза"/>
    <div id="timer">30</div>
    <div id="score">Точность: —</div>
    <button id="skip-pose-btn" class="btn btn-skip">Пропустить позу</button>
  </div>

  <!-- 4) Завершение -->
  <div id="finish-container" class="card">
    <h2>Тренировка завершена!</h2>
    <button id="finish-btn" class="btn btn-start">В личный кабинет</button>
  </div>
</div>

<script>
(async () => {
  /* ───── 0. План из URL ───── */
  const params  = new URLSearchParams(location.search);
  const poseIds = (params.get('poses') || '').split(',').map(Number).filter(Boolean);

  const token   = localStorage.getItem('token');
  if (!token) return location.href = 'login.html';
  const headers = { Authorization: `Bearer ${token}` };

  const allPoses = await fetch('/poses/', { headers }).then(r => r.json());
  const PLAN     = allPoses.filter(p => poseIds.includes(p.id));

  /* ───── 1. DOM ───── */
  const $ = id => document.getElementById(id);
  const video=$('video'), canvas=$('canvas'), ctx=canvas.getContext('2d');
  const startBtn=$('start-btn'), instrCard=$('instr-container'),
        instrVideo=$('instr-video'), skipInstr=$('skip-instr-btn'),
        poseLabel=$('pose-label'), camCard=$('camera-container'),
        poseLabel2=$('pose-label-2'), refImg=$('ref-img'),
        timerEl=$('timer'), scoreEl=$('score'), skipPose=$('skip-pose-btn'),
        finishCard=$('finish-container'), finishBtn=$('finish-btn');

  const sections=['controls','instr-container','camera-container','finish-container'];
  const showOnly=id=>sections.forEach(x=>$(x).classList.toggle('active',x===id));

  /* ───── 2. State ───── */
  let idx=0, timerInt, streamInt, ws;
  let lastScore=0, sessionStartedISO, collected=[];

  const sendPose = key => {
    const msg=JSON.stringify({type:'pose',poseName:key});
    (ws.readyState===WebSocket.OPEN)
      ? ws.send(msg)
      : ws.addEventListener('open',()=>ws.send(msg),{once:true});
  };

  /* ───── 3. Старт ───── */
  startBtn.onclick = async () => {
    sessionStartedISO=new Date().toISOString();

    /* камера */
    try{
      video.srcObject=await navigator.mediaDevices.getUserMedia({video:true});
    }catch{ return alert('Нет доступа к камере'); }
    video.onloadedmetadata=()=>{
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    };

    /* сокет */
    ws=new WebSocket(`ws://${location.hostname}:8000/ws/stream?token=${token}`);
    ws.onmessage=e=>drawPose(JSON.parse(e.data));
    ws.onerror=console.error;

    nextPose();
  };

  /* ───── 4. Цикл позы ───── */
  function nextPose(){
    clearInterval(timerInt); clearInterval(streamInt);
    if(idx>=PLAN.length) return finish();

    const p=PLAN[idx], key=p.video_url.split('/').pop().split('.')[0];
    poseLabel.textContent=p.name; instrVideo.src=p.video_url;
    showOnly('instr-container'); sendPose(key);

    instrVideo.onended=skipInstr.onclick=startPose;
  }

  function startPose(){
    instrVideo.pause(); instrVideo.currentTime=0;
    const p=PLAN[idx], key=p.video_url.split('/').pop().split('.')[0];

    poseLabel2.textContent=p.name; refImg.src=`images/${key}.png`;
    showOnly('camera-container');

    let t=p.duration||30; timerEl.textContent=t;
    timerInt=setInterval(()=>{
      t--; timerEl.textContent=t;
      if(t<=0){ recordScore(); idx++; nextPose(); }
    },1000);

    streamInt=setInterval(()=>{
      const tmp=document.createElement('canvas');
      tmp.width=canvas.width; tmp.height=canvas.height;
      tmp.getContext('2d').drawImage(video,0,0);
      tmp.toBlob(b=>{
        const fr=new FileReader();
        fr.onloadend=()=>ws.send(JSON.stringify({image:fr.result}));
        fr.readAsDataURL(b);
      },'image/jpeg',0.8);
    },150);
  }

  skipPose.onclick=()=>{ recordScore(); idx++; nextPose(); };

  /* ───── 5. Отрисовка + метрика ───── */
  function drawPose(msg){
    if(msg.error) return;
    if(msg.score!==undefined){
      lastScore=msg.score;
      scoreEl.textContent=`Точность: ${msg.score}%`;
    }
    if(!msg.landmarks||!msg.connections) return;

    const bad=new Set(msg.bad_points||[]);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    msg.connections.forEach(([i,j])=>{
      const lm=msg.landmarks;
      if(!lm[i]||!lm[j]||lm[i].visibility<0.5||lm[j].visibility<0.5) return;
      ctx.beginPath();
      ctx.moveTo(lm[i].x*canvas.width,lm[i].y*canvas.height);
      ctx.lineTo(lm[j].x*canvas.width,lm[j].y*canvas.height);
      ctx.strokeStyle=bad.has(i)||bad.has(j)?'red':'lime';
      ctx.lineWidth=2; ctx.stroke();
    });
  }

  const recordScore=()=>{           // фиксируем результат позы
    if(idx>=PLAN.length) return;
    collected.push({pose_id:PLAN[idx].id,score:lastScore});
    lastScore=0;
  };

  /* ───── 6. Финиш ───── */
  async function finish(){
    clearInterval(timerInt); clearInterval(streamInt);
    if(ws?.readyState===WebSocket.OPEN) ws.close();
    await saveSession();
    showOnly('finish-container');
  }
  finishBtn.onclick=()=>location.href='dashboard.html';

  /* ───── 7. POST /sessions/ ───── */
  async function saveSession(){
    if(!collected.length) return;
    const totalSeconds=Math.floor((Date.now()-Date.parse(sessionStartedISO))/1000);

    const payload={
      total_time: totalSeconds,
      pose_scores: collected        // <-- имя поля, которое ждёт бэкенд
      // workout_id: можно добавить, если передаёте ?planId=...
    };

    try{
      const r=await fetch('/sessions/',{
        method:'POST',
        headers:{...headers,'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      if(!r.ok) console.error('Save session error',await r.text());
    }catch(e){ console.error(e); }
  }
})();
</script>
</body>
</html>
